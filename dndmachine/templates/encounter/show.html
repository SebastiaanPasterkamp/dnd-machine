{% extends "layout.html" %}
{% block body %}
<h2 class="icon fa-gamepad">{{ encounter.name }}</h2>

<div class="nice-row">
    <div class="nice-col-7 nice-col-mobile-12">

<table class="nice-table condensed striped bordered hover">
    <thead>
        <tr>
            <th colspan="2">
                <h3>{{ encounter.name }}</h3>
                {% if encounter.user_id == request.user.id or 'admin' in request.user.role %}
                <div class="nice-btn-group pull-right">
                    <a href="{{ url_for('encounter.edit', encounter_id=encounter.id) }}" class="nice-btn icon fa-cog">Edit</a>
                    <a href="{{ url_for('encounter.delete', encounter_id=encounter.id) }}" class="nice-btn icon bad fa-trash">Delete</a>
                </div>
                {% endif %}
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th>Description</th>
            <td>{{ encounter.description }}</td>
        </tr>
    </tbody>
</table>

    </div>
    <div class="nice-col-5 nice-col-mobile-12">

<h3>Party Encounter Challenge Rating</h3>

<table class="nice-table condensed striped bordered hover" id="party">
    <thead>
        <tr>
            <th>Party name</th>
            <th>Party size</th>
            <th class="info">Easy</th>
            <th class="good">Medium</th>
            <th class="warning">Hard</th>
            <th class="bad">Deadly</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ party.name }}</td>
            <td>{{ party.size }}</td>
            <td class="info">{{ party.easy }} XP</td>
            <td class="good">{{ party.medium }} XP</td>
            <td class="warning">{{ party.hard }} XP</td>
            <td class="bad">{{ party.deadly }} XP</td>
        </tr>
    </tbody>
</table>

<h3>Modified Encounter Challenge Rating</h3>

<table class="nice-table condensed striped bordered hover" id="modifier">
    <thead>
        <tr>
            <th>Encounter Rating</th>
            <th>Monster Modifier</th>
            <th>Party Modifier</th>
            <th>Final Modifier</th>
            <th>Modified Encounter Rating</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ encounter.challenge_rating|round(3) }} / {{ encounter.xp_rating|int }} XP</td>
            <td>{{ encounter.modifier.monster }}</td>
            <td>{{ encounter.modifier.party }}</td>
            <td>{{ encounter.modifier.total }}</td>
            {% if (encounter.xp_modified <= (party.easy + (party.medium-party.easy)/2)) %}
            <td class="info">
            {% elif (encounter.xp_modified <= (party.medium + (party.hard-party.medium)/2)) %}
            <td class="good">
            {% elif (encounter.xp_modified <= (party.hard + (party.deadly-party.hard)/2)) %}
            <td class="warning">
            {% else %}
            <td class="bad">
            {% endif %}
                {{ encounter.challenge_modified }} / {{ encounter.xp_modified|int }} XP
            </td>
        </tr>
    </tbody>
</table>

    </div>
</div>

{% if mode == 'combat' %}
<h3>Combat</h3>

<form method="POST" action="?initiative">
{% else %}
<h3>Initiative</h3>

<form method="POST">
{% endif %}

<div class="nice-row">
    {% for c in combatants %}
    <div class="nice-col-2 nice-col-mobile-4">
        <span>{{ c.name }}</span>
        {% if mode == 'combat' %}
        {% set percent = c.current_hit_points * 100 / c.hit_points %}
        {% if c.current_hit_points <= 0 %}
        <div class="nice-progress small bad text-align-center">
            Dead
        </div>
        {% elif percent < 33 %}
        <div class="nice-progress small bad">
            <div class="nice-progress-fill" style="width: {{ percent }}%;">
                {{ c.current_hit_points }}
            </div>
        </div>
        {% elif percent < 66 %}
        <div class="nice-progress small warning">
            <div class="nice-progress-fill" style="width: {{ percent }}%;">
                {{ c.current_hit_points }} / {{ c.hit_points }}
            </div>
        </div>
        {% else %}
        <div class="nice-progress small good">
            <div class="nice-progress-fill" style="width: {{ percent }}%;">
                {{ c.current_hit_points }} / {{ c.hit_points }}
            </div>
        </div>
        {% endif %}
        <input name="damage-taken-{{ c.index }}" placeholder="Damage taken..." class="nice-form-control small" value="{{ c.damage_taken }}" />
        <input type="hidden" name="initiative-{{ c.index }}" placeholder="Initiative..." class="nice-form-control small" value="{{ c.initiative }}" />
        {% else %}
        <input type="number" min="0" max="30" name="initiative-{{ c.index }}" placeholder="Initiative..." class="nice-form-control small" value="{{ c.initiative }}" />
        <input type="hidden" name="damage-taken-{{ c.index }}" placeholder="Damage taken..." class="nice-form-control small" value="{{ c.damage_taken }}" />
        {% endif %}
    </div>
    {% endfor %}

    <div class="nice-btn-group pull-right">
    {% if mode == 'combat' %}
        <button name="mode" value="initiative" class="nice-btn accent icon fa-order">Change Initiative</button>
        <button name="mode" value="{{ mode }}" class="nice-btn primary icon fa-refresh">Update</button>
    {% else %}
        <button name="mode" value="{{ mode }}" class="nice-btn info icon fa-refresh">Update</button>
        <button name="mode" value="combat" class="nice-btn primary icon fa-gamepad">Combat</button>
    {% endif %}
    </div>
</div>

</form>

<h3>Monsters</h3>

{% for info in monsters %}
{% set monster = info.monster %}
<div class="nice-row">
    <div class="nice-col-5 nice-col-mobile-12">

<table class="nice-table condensed striped bordered hover" id="monsterstats">
    <thead>
        <tr>
            <th colspan="2">
                <h3>{{ monster.name }}{% if info.count > 1 %} x {{ info.count }}{% endif %}</h3>
                <i>
                    {{ monster.size }}
                    {{ monster.type }},
                    {{ monster.alignment }}
                </i>
                <span class="badge pull-right">
                    <a href="{{ url_for('monster.edit', monster_id=monster.id) }}" class="nice-btn icon fa-cog">Edit</a>
                </span>
            </th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <th>Level</th>
            <td>{{ monster.level }}</td>
        </tr>
        <tr>
            <th>Armor Class</th>
            <td>{{ monster.armor_class }}</td>
        </tr>
        <tr>
            <th>Hit Points</th>
            <td>
                {{ monster.hit_points }}
                <i>({{ monster.hit_points_notation }})</i>
            </td>
        </tr>
        <tr>
            <th>Speed</th>
            <td>
                {% for mode, speed in monster.motion.iteritems() %}
                {% if speed %}
                    <strong>{{ mode|capitalize }}:</strong> {{ speed }} ft.
                {% endif %}
                {% endfor %}
            </td>
        </tr>
    </tbody>
</table>

{% set stats = ["strength", "dexterity", "constitution", "intelligence", "wisdom", "charisma"] %}
<table class="nice-table condensed striped bordered hover" id="statblock">
    <thead>
        <tr>
            {% for stat in stats %}
            <th>{{ stat|capitalize }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        <tr>
            {% for stat in stats %}
            <td>
                {{ monster.stats[stat] }}
                (
                    {% if monster.modifiers[stat] > 0 %}+{% endif %}
                    {{ monster.modifiers[stat] }}
                )
            </td>
            {% endfor %}
        </tr>
    </tbody>
</table>

<table class="nice-table condensed striped bordered hover">
    <tbody>
        {% for trait in monster.traits %}
        <tr>
            <th>{{ trait.name }}</th>
            <td>{{ trait.description|markdown }}</td>
        </tr>
        {% endfor %}
        {% for feature in monster.features %}
        <tr>
            <th>{{ feature.name }}</th>
            <td>{{ feature.description }}</td>
        </tr>
        {% endfor %}
        {% if monster.languages %}
        <tr>
            <th>Languages</th>
            <td>
                <div class="nice-tags-container">
                    {% for language in monster.languages %}
                    {% if language %}
                    <div class="nice-tag">
                        <span class="nice-tag-label">
                            {{ language }}
                        </span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </td>
        </tr>
        {% endif %}
        <tr>
            <th>Challenge Rating</th>
            <td>{{ monster.challenge_rating|round(3) }} ({{ monster.xp }} XP)</td>
        </tr>
        <tr>
            <th>Proficiency</th>
            <td>{{ monster.proficiency }}</td>
        </tr>
    </tbody>
</table>

    </div>
    <div class="nice-col-7 nice-col-mobile-12">

<table class="nice-table condensed striped bordered hover">
    <tbody>
        <tr>
            <th colspan="2"><h3>Actions</h3></th>
        </tr>
        {% for i in range(monster.attacks|length) %}
        {% set attack = monster.attacks[i] %}
        <tr>
            <th colspan="2">
                <h4>{{ attack.name }}</h4>
                <i>{{ attack.description }}</i>
            </th>
        </tr>
        <tr>
            <th>Mode</th>
            <td>{{ attack.mode }}</td>
        </tr>
        <tr>
            <th>Attack Notation</th>
            <td>{{ attack.notation }}</td>
        </tr>
        <tr>
            <th>Attack Damage</th>
            <td>
                <div class="nice-tags-container">
                    <div class="nice-tag">
                        <span class="nice-tag-label">
                            Average
                        </span>
                        <span class="nice-tag-badge">
                            {{ attack.average }}
                        <span>
                    </div>
                    <div class="nice-tag accent">
                        <span class="nice-tag-label">
                            Critical average
                        </span>
                        <span class="nice-tag-badge">
                            {{ attack.critical }}
                        <span>
                    </div>
                </div>
            </td>
        </tr>
        {% if attack.bonus %}
        <tr>
            <th>Attack Bonus</th>
            <td>{% if attack.bonus > 0 %}+{% endif %}{{ attack.bonus }}</td>
        </tr>
        {% endif %}
        {% if attack.spell_save_dc %}
        <tr>
            <th>Attack Save DC</th>
            <td>&ge; {{ attack.spell_save_dc }}</td>
        </tr>
        {% endif %}
        <tr>
            <th>Target</th>
            <td>{{ attack.target }}</td>
        </tr>
        <tr>
            <th>Range</th>
            <td>
                {% if attack.range_min < attack.range_max %}
                {{ attack.range_min }} -
                {% endif %}
                {{ attack.range_max }} ft.
            </td>
        </tr>
        {% if attack.on_hit %}
        <tr>
            <th>On Hit</th>
            <td>{{ attack.on_hit }}</td>
        </tr>
        {% endif %}
        {% if attack.on_mis %}
        <tr>
            <th>On Mis</th>
            <td>{{ attack.on_mis }}</td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

{% if monster.multiattack %}
<table class="nice-table condensed striped bordered hover">
    <tbody>
        <tr>
            <th colspan="2"><h3>Actions</h3></th>
        </tr>
        <tr>
            <th colspan="2"><h3>Multiattack</h3></th>
        </tr>
        <tr>
            <th>Multiattack</th>
            <td>
            {% for rotation in monster.multiattack %}
                {{ rotation.name }}
                <i>({{ rotation.condition }})</i>
                {{ rotation.description|replace('%average%', rotation.average) }}
                <div class="nice-tags-container">
                    {% for attack in rotation.sequence %}
                    <div class="nice-tag">
                        <span class="nice-tag-label">
                            {{ attack }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            {% endfor %}
            </td>
        </tr>
    </tbody>
</table>
{% endif %}


    </div>
</div>
{% endfor %}

{% endblock %}
