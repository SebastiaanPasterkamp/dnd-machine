{% macro widget_existing(existing, path=[], disabled=False) -%}
<ul>
{%- for field, gift in existing.items() %}
    <li>
        <strong>{{ field|field_title }}</strong>:
        {% if gift is mapping -%}
        {%- if 'name' in gift -%}

        {{ gift.label|default(gift.name) }}

        {%- else -%}

        <ul>
            {%- for name, item in gift.items() %}
            <li>
                <strong>{{ name }}</strong>
                {{ (item.description|default('description') % item)|markdown }}
            </li>
            {%- endfor %}
        </ul>

        {%- endif -%}

        {%- elif gift is string -%}

        {{ gift }}

        {%- else -%}

        {{ gift|join(', ') }}

        {%- endif %}
    </li>
{%- endfor %}
</ul>
{%- endmacro %}

{% macro widget_given(given, path=[], disabled=False) -%}
<ul>
{%- for field, gift in given.items() %}
    <li>
        <strong>{{ field|field_title }}</strong>:
        {% if gift is mapping -%}
        {%- if 'name' in gift -%}

        <input{{ {
            "type": "hidden",
            "name": (path + [field])|join('.'),
            "value": gift.name
            }|xmlattr }}
            {%- if disabled %} disabled{%- endif -%} />
        {{ gift.label|default(gift.name) }}

        {%- else -%}

        {% for chldfield, chlditem in gift.items() -%}
        <input{{ {
            "type": "hidden",
            "name": (path + [field, chldfield])|join('.'),
            "value": chlditem
            }|xmlattr }}
        {%- if disabled %} disabled{%- endif -%} />
        {% endfor -%}
        <p>
        {% if 'description' in gift %}
        {{ (gift.description % gift)|markdown }}
        {% else %}
        {% for chldfield, chlditem in gift.items() -%}
        <strong>{{ chldfield|field_title }}</strong>: {{ chlditem }}<br/>
        {% endfor -%}
        {% endif %}
        </p>

            {%- endif -%}

        {%- elif gift is string -%}

        <input{{ {
            "type": "hidden",
            "name": (path + [field])|join('.'),
            "value": gift
            }|xmlattr }}
            {%- if disabled %} disabled{%- endif -%} />
        {{ gift }}

        {%- else -%}

            {%- for item in gift -%}
        <input{{ {
            "type": "hidden",
            "name": (path + [field])|join('.'),
            "value": item
            }|xmlattr }}
            {%- if disabled %} disabled{%- endif -%} />
            {%- endfor -%}
        {{ gift|join(', ') }}

        {%- endif %}
    </li>
{%- endfor %}
</ul>
{%- endmacro %}

{% macro widget_group(group, path=[], disabled=False) -%}
{%- for item in group -%}
<input{{ {
    "type": "hidden",
    "name": path|join('.'),
    "value": item
    }|xmlattr }}
    {%- if disabled %} disabled{%- endif -%} />
{% endfor -%}
<span{{ {
    "class": "nice-form-control",
    "style": "background-color: #ECF0F1"
    }|xmlattr }} >
    {{ group|join(', ') }}
</span>
{%- endmacro %}

{% macro widget_select(select, path=[], disabled=False) -%}
<select{{ {
    "class": "nice-form-control",
    "name": path|join('.')
    }|xmlattr }}
    {%- if disabled %} disabled{% endif -%}>
    {% for item in select -%}
    {% if item is mapping -%}
    <option{{ {"value": item.name }| xmlattr }}>{{ item.label|default(item.name) }}</option>
    {%- else -%}
    <option{{ {"value": item }| xmlattr }}>{{ item }}</option>
    {% endif -%}
    {%- endfor %}
</select>
{%- endmacro -%}

{% macro widgets(config, path=[], disabled=False) -%}
{% if 'existing' in config -%}
    {{ widget_existing(config.existing, path, disabled) }}
{%- endif -%}
{% if 'given' in config -%}
    {{ widget_given(config.given, path, disabled) }}
{%- endif -%}
{% if 'group' in config -%}
    {{ widget_group(config.group, path, disabled) }}
{%- endif -%}
{% if 'select' in config -%}
    {{ widget_select(config.select, path, disabled) }}
{%- endif -%}
{% if 'options' in config -%}
    {{ widget_options(config.options, path, disabled) }}
{%- endif -%}
{% if 'choose' in config -%}
    {{ widget_choose(config.choose, path, disabled) }}
{%- endif -%}
{% if 'multiple' in config -%}
    {{ widget_multiple(config.multiple, path, disabled) }}
{%- endif -%}
{% if 'tabs' in config -%}
    {{ widget_tabs(config.tabs, path, disabled) }}
{%- endif -%}
{% endmacro %}

{% macro widget_choose(choose, path=[], disabled=False) -%}
<table class="nice-table bordered itemset{% if disabled %} disabled{% endif %}">
    {%- set radio_name = {"choose": choose, "path": path, "disabled": disabled}|md5 -%}
    {% for choice in choose %}
    <tr>
        <th>
            <input{{ {
                "type": "radio",
                "name": radio_name
                }| xmlattr }}
                {%- if loop.first %} checked{%- endif -%}
                {%- if disabled %} disabled{%- endif -%} />
        </th>
        <td{{ {
            "class": "disabled" if (disabled or not loop.first) else None
            }|xmlattr }}>
            {{ widgets(choice, path, disabled or not loop.first)|indent(12)|safe }}
        </td>
    </tr>
    {%- endfor %}
</table>
{% endmacro -%}

{% macro widget_options(options, path=[], disabled=False) -%}
{% for field, items in options.items() -%}
<div style="width: 24%; padding: .5em; float: left">
<ol class="nice-breadcrumb small">
    {% for title in field.split('.') -%}
    <li>{{ title|field_title }}</li>
    {%- endfor %}
</ol>
<ul class="nice-menu stacked" style="padding-left: 1em;">
{% for item in items %}
    <li>
{{ widgets(item, path + [field], disabled) }}
    </li>
{% endfor -%}
</ul>
</div>
{% endfor -%}
{%- endmacro %}

{% macro widget_multiple(multiple, path=[], disabled=False) -%}
{% for item in multiple -%}
{{ widgets(item, path, disabled) }}
{% endfor -%}
{%- endmacro %}

{% macro widget_tabs(tabs, path=[], disabled=False) -%}
{%- set tab_name = {"tabs": tabs, "path": path, "disabled": disabled}|md5 -%}
<div{{ {
        "class": "nice-tabs-wrapper",
        "id": tab_name}|xmlattr }}>
    {{ tabs.description }}
    <ul class="nice-tabs">
        {%- for option in tabs.options %}
        <li{{ {
                "data-name": option.name|md5,
                "class": ' '.join([
                    "current" if loop.first else '',
                    "disabled" if disabled else ''
                    ])
                }|xmlattr }}>
            <a>
                {{ option.name|capitalize }}
            </a>
        </li>
        {%- endfor %}
    </ul>
    <ul class="nice-tab-content">
        {%- for option in tabs.options %}
        <li{{ {
                "data-name": option.name|md5,
                "class": "current" if loop.first else None
                }|xmlattr }}>
            {{ widgets(option, path, disabled or not loop.first)|indent(12)|safe }}
        </li>
        {%- endfor %}
    </ul>
</div>
{% endmacro -%}
