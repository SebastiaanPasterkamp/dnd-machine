{% extends "tabbed-layout.html" %}

{% set completed = character.creation %}

{%- macro attribute(path, choises, given=[], attr='') -%}

{% if given %}
<ul>
{% for g in given %}
    <li>{{ g }}</li>
{% endfor %}
</ul>
{% endif %}

{% for choise in choises %}

    {% if 'options' in choise %}
    <select class="small nice-form-control" {{ attr }} name="character.{{ path }}[]">
        {% for option in choise.options %}
        {% if option is mapping %}
        <option valeu="{{ option.name }}">{{ option.label|default(option.name) }}</option>
        {% else %}
        <option>{{ option }}</option>
        {% endif %}
        {% endfor %}
    </select>
    {% endif %}

    {% if 'choose' in choise %}
    <table class="nice-table condensed bordered itemset">
        {% for set in choise.choose %}
        <tr>
            <td><input type="radio" name="{{ choise.choose }}" {% if loop.first %}checked{% endif %}/></td>
            <td>{{
                attribute(
                    path,
                    [set],
                    attr='disabled' if not loop.first else ''
                )
            }}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    {% if 'multiple' in choise %}
        {% for set in choise.multiple %}
        {{ attribute(
            path,
            set
            ) }}
        {% endfor %}
    {% endif %}

    {% if 'group' in choise %}
        {{ choise.group|join(', ') }}
        {% for set in choise.group %}
        <input type="hidden" name="character.{{ path }}[]" {{ attr }} value="{{ set }}" />
        {% endfor %}
    {% endif %}
{% endfor %}
{% endmacro -%}

{% block title %}
<h1 class="icon fa-pencil-square-o">Edit Character</h1>
{% endblock title %}

{% block content %}
{% for tab, done, current in tabs|completed(completed) %}

<li class="{{ 'current' if current else '' }}" data-name="{{ tab }}">

{% if not done %}
    <form action="{{ url_for('character.edit', phase=phase, character_id=character.id) }}" method="post">
        <input type="hidden" name="character.creation[]" value="{{ tab }}" />

        {{ buttons }}
{% endif %}

{% if tab == "core" %}
    {% if not done %}
<table class="nice-table condensed bordered nice-form-group">
    <tbody>
        <tr>
            <th>Name</th>
            <td><input class="small nice-form-control" name="character.name" placeholder="Name..."></td>
        </tr>
        <tr>
            <th>Alignment</th>
            <td>
                <select class="nice-form-control" name="character.alignment">
                {% for b in ['good', 'neutral', 'evil'] %}
                {% for a in ['lawful', 'neutral', 'chaotic'] %}
                    {% set alignment = ('true' if a == b else a) + ' ' + b %}
                    <option value="{{ alignment }}">{{ alignment|capitalize }}</option>
                {% endfor %}
                {% endfor %}
                </select>
            </td>
        </tr>
    </tbody>
</table>
    {% else %}
<table class="nice-table condensed bordered">
    <tbody>
        <tr>
            <th>Name</th>
            <td>{{ character.name }}</td>
        </tr>
        <tr>
            <th>Alignment</th>
            <td>{{ character.alignment }}</td>
        </tr>
    </tbody>
</table>
    {% endif %}
{% endif %}

{% if tab == "stats" %}
    {% if not done %}
<table class="nice-table condensed bordered nice-form-group" id="statsblockeditor">
    <thead>
        <tr>
            <th>Statistic</th>
            <th>Base</th>
            <th>Bonus</th>
            <th>Final</th>
            <th>Modifier</th>
        </tr>
    </thead>
    <tbody>
        {% for stat in items.statistics %}
        {% set class = "" %}
        {% if stat.name == character.spell_stat %}
            {% set class = "good" %}
        {% elif stat.name in character.proficiencies.saving_throws %}
            {% set class = "info" %}
        {% endif %}
        <tr class="{{ class }}">
            <th>{{ stat.name }}</th>
            <td class="{{ class }}">
                <select class="small nice-form-control" data-field="base" name="character.base_stats.{{ stat.name }}">
                {% for option in range(8, 16) %}
                    {% if character.base_stats[stat.name] == option %}
                    <option selected>{{ option }}</option>
                    {% else %}
                    <option>{{ option }}</option>
                    {% endif %}
                {% endfor %}
                </select>
            </td>
            <td class="{{ class }}">
                <input type="number" disabled value="{{ character.stats_bonus[stat.name]|sum }}" data-field="bonus" class="nice-form-control" />
            </td>
            <td class="{{ class }}">
                <input type="number" disabled value="{{ character.stats[stat.name] }}" data-field="final" class="nice-form-control" />
            </td>
            <td class="{{ class }}">
                <input type="number" disabled value="{{ character.modifiers[stat.name] }}" data-field="modifier" class="nice-form-control" />
            </td>
        </tr>
        {% endfor %}
    </tbody>
    <tfooter>
        <tr>
            <th>Budget</th>
            <th>
                <input type="number" disabled id="budget" data-total="27" value="27" class="nice-form-control" />
            </th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </tfooter>
</table>
    {% else %}
<table class="nice-table condensed bordered">
    <thead>
        <tr>
            <th>Statistic</th>
            <th>Base</th>
            <th>Bonus</th>
            <th>Final</th>
            <th>Modifier</th>
        </tr>
    </thead>
    <tbody>
        {% for stat in items.statistics %}
        {% if stat.name == character.spell_stat %}
        <tr class="good">
        {% elif stat.name in character.proficiencies.saving_throws %}
        <tr class="info">
        {% else %}
        <tr>
        {% endif %}
            <th>{{ stat.name }}</th>
            <td>{{ character.base_stats[stat.name] }}</td>
            <td>{{ character.stats_bonus[stat.name]|sum|bonus }}</td>
            <td><strong>{{ character.stats[stat.name] }}</strong></td>
            <td><strong>{{ character.modifiers[stat.name]|bonus }}</strong></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
    {% endif %}
{% endif %}

{% if tab == "equip" %}
    {% if not done %}
<table class="nice-table condensed bordered nice-form-group">
    <tbody>
    {% if options.languages|default({}) %}
        <tr>
            <th>Languages</th>
            <td>
                {{ attribute(
                    'languages',
                    options.languages|default({}),
                    character.languages|default([])
                ) }}
            </td>
        </tr>
    {% endif %}

    {% for type, profs in character.proficiencies.items() %}
    {% set opt = options.proficiencies|default({}) %}
    {% if profs or type in opt %}
        <tr>
            <th>{{ type }} proficiency</th>
            <td>{{ attribute(
                'proficiencies.' + type,
                opt[type]|default({}),
                profs|default([])
            ) }}</td>
        </tr>
    {% endif %}
    {% endfor %}

    {% if options.spells|default({}) %}
        <tr>
            <th>Spells</th>
            <td>
                {{ attribute(
                    options.spells|default({}),
                    'spells',
                    character.spells|default([])
                ) }}
            </td>
        </tr>
    {% endif %}

    {% if options.equipment|default({}) %}
        <tr>
            <th>Equipment</th>
            <td>
                {{ attribute(
                    'equipment',
                    options.equipment|default({}),
                    character.equipment|default([])
                ) }}
            </td>
        </tr>
    {% endif %}
    </tbody>
</table>
    {% else %}
<table class="nice-table condensed bordered">
    <tbody>
    {% if character.languages %}
        <tr>
            <th>Languages</th>
            <td>
                <ul>
                {% for lang in character.languages %}
                    <li>{{ lang }}</li>
                {% endfor %}
                </ul>
            </td>
        </tr>
    {% endif %}

    {% for type, profs in character.proficiencies.items() %}
        <tr>
            <th>{{ type }}</th>
            <td>
                <ul>
                {% for prof in character.proficiencies[prof] %}
                    <li>{{ prof }}</li>
                {% endfor %}
                </ul>
            </td>
        </tr>
    {% endfor %}

    {% if character.spells %}
        <tr>
            <th>Spells</th>
            <td>
                <ul>
                {% for spell in character.spells %}
                    <li>{{ spell }}</li>
                {% endfor %}
                </ul>
            </td>
        </tr>
    {% endif %}

    {% if character.equipment %}
        <tr>
            <th>Equipment</th>
            <td>
                <ul>
                {% for item in character.equipment %}
                    <li>{{ item }}</li>
                {% endfor %}
                </ul>
            </td>
        </tr>
    {% endif %}
    </tbody>
</table>
    {% endif %}
{% endif %}

{% if not done %}
        {{ buttons }}

    </form>
{% endif %}

</li>

{% endfor %}
{% endblock content %}
